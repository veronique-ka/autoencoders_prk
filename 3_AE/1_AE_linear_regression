import timeit
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error
from sklearn.metrics import r2_score
from sklearn.metrics import mean_absolute_error
from statistics import median

# Set start time
start_time = timeit.default_timer()

# Load data
prk = pd.read_csv("https://raw.githubusercontent.com/veronique-ka/autoencoders_prk/master/prk_reord_bin.csv")

#Convert pandas dataframe to numpay array
p=np.array(prk)

# Initiate lists of metrics, based on 10 iterations (trials)
MSE_test_10 = list()
R2_test_10 = list()
MAE_test_10 =list()

for i in range(0,10):
    #split into train and test
    print("Partition number=", i)
    from sklearn.model_selection import train_test_split
    split = train_test_split(p, test_size=0.3)
    train=split[0]
    test=split[1]
    x_train=train[:,1:20]
    y_train=train[:,20]
    x_test=test[:,1:20]
    y_test=test[:,20]
    
    # normalize values between 0 and 1 and
    from sklearn.preprocessing import MinMaxScaler
    min_max=MinMaxScaler()
    x_train=min_max.fit_transform(x_train)
    x_test=min_max.fit_transform(x_test)
    
 
    # Vanilla AE
    from keras.layers import Input, Dense
    from keras.models import Model
    #Encoder
    #encoded representations - CODE
    encoding_dim=3
    
    # input placeholder
    input_sample = Input(shape=(19,))
    encoded = Dense(3, activation='sigmoid')(input_sample)
    decoded = Dense(19, activation='sigmoid')(encoded)
    autoencoder = Model(input_sample, decoded)
    autoencoder.summary()
    
    #  train autoencoder to reconstruct .
    # compile
    autoencoder.compile(optimizer='adam', loss='binary_crossentropy')
    
    autoencoder.fit(x_train, x_train,
                    epochs=200,
                    batch_size=64,
                    shuffle=True,
                    validation_data=(x_test, x_test))
    
    encoder = Model(input_sample, encoded)
    encoded_input = Input(shape=(encoding_dim,))
    
    # get the code
    encoded_train=encoder.predict(x_train)
    encoded_test=encoder.predict(x_test)
    
    # MULTIPLE REGRESSION MODEL
    from sklearn.linear_model import LinearRegression
    lr = LinearRegression()
    lr.fit(encoded_train, y_train)
    test_predictions = lr.predict(encoded_test)

    # to check MSE
    from sklearn.metrics import mean_squared_error
    MSE_test_5.append(mean_squared_error(y_test, test_predictions))
    
    # chek R2
    from sklearn.metrics import r2_score
    R2_test_5.append(r2_score(y_test, test_predictions))
    
    #check absolute error
    from sklearn.metrics import mean_absolute_error
    MAE_test_5.append(mean_absolute_error(y_test,test_predictions))

print("MSE_test_5 =", MSE_test_5)
print("R2_test_5 =", R2_test_5) 
print("MAE_test_5=", MAE_test_5) 

from statistics import median
MSE_final=median(MSE_test_5)
R2_final=median(R2_test_5)
MAE_final=median(MAE_test_5)
print("MSE_final=", MSE_final)
print("R2_final=", R2_final)
print("MAE_final=", MAE_final)

end_time = timeit.default_timer()
hours, rem = divmod(end_time-start_time, 3600)
minutes, seconds = divmod(rem, 60)
print ("{:0>2}:{:0>2}:{:05.2f}".format(int(hours),int(minutes),seconds))    


